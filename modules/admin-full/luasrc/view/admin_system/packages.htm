<%#
LuCI - Lua Configuration Interface
Copyright 2008 Steven Barth <steven@midlink.org>
Copyright 2008 Jo-Philipp Wich <xm@leipzig.freifunk.net>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id$

-%>
<%-
local bit = require "bit"
local rowcnt = 1

function rowstyle()
	rowcnt = rowcnt + 1
	return (rowcnt % 2) + 1
end

function opkg_error(code)
	code = bit.rshift(tonumber(code), 8)
	return translate(
		'a_s_packages_code%i' % code,
		'%s %i' % { translate('Code'), code }
	)
end
-%>
<%+header%>
<h2><a id="content" name="content"><%:System%></a></h2>
<h3><%:Software%></h3>

<br />

<% if install or remove or update or upgrade then %>
<div class="code"><strong><%:Status%>:</strong><br />
<% if update then %>
	<%:Package lists updated%>: <% if update == 0 then %><span class="ok"><%:OK%></span><% else %><span class="error"><%:Error%> (<%=opkg_error(update)%>)</span><% end %><br />
<% end %>
<% if upgrade then%>
	<%:Upgrade installed packages%>: <% if upgrade == 0 then %><span class="ok"><%:OK%></span><% else %><span class="error"><%:Error%> (<%=opkg_error(upgrade)%>)</span><% end %><br />
<% end %>
<% if install then for k,v in pairs(install) do %>
	<%:Install%> '<%=k%>': <% if v == 0 then %><span class="ok"><%:OK%></span><% else %><span class="error"><%:Error%> (<%=opkg_error(v)%>)</span><% end %><br />
<% end end %>
<% if remove then for k,v in pairs(remove) do %>
	<%:Remove%> '<%=k%>': <% if v == 0 then %><span class="ok"><%:OK%></span><% else %><span class="error"><%:Error%> (<%=opkg_error(v)%>)</span><% end %><br />
<% end end %>
</div>
<br />
<% end %>

<form method="post" action="<%=REQUEST_URI%>">
	<div class="cbi-map">
		<fieldset class="cbi-section">
			<ul>
				<li><a href="<%=REQUEST_URI%>/ipkg"><%:Edit package lists and installation targets%></a></li>
				<li><a href="<%=REQUEST_URI%>?update=1"><%:Update package lists%></a></li>
			</ul>
			<br />
			<fieldset class="cbi-section-node">
			<div class="cbi-value">
				<label class="cbi-value-title"><%:Download and install package%>:</label>
				<div class="cbi-value-field">
					<input type="text" name="url" size="30" value="" />
					<input class="cbi-input-save" type="submit" name="submit" value="<%:OK%>" />
				</div>
			</div>

			<div class="cbi-value">
				<label class="cbi-value-title"><%:Filter%>:</label>
				<div class="cbi-value-field">
					<input type="text" name="query" size="20" value="<%=query%>" />
					<input type="submit" class="cbi-input-find" name="search" value="<%:Find package%>" />
				</div>
			</div>

			<table class="cbi-section-table">
				<tr class="cbi-section-table-titles">
					<th class="cbi-section-table-cell"><%:Package name%></th>
					<th class="cbi-section-table-cell"><%:Version%></th>
					<th class="cbi-section-table-cell"><%:Install%></th>
					<th class="cbi-section-table-cell"><%:Delete%></th>
					<th class="cbi-section-table-cell"><%:Description%></th>
				</tr>
				<% for k, pkg in pairs(pkgs) do %>
				<tr class="cbi-section-table-row cbi-rowstyle-<%=rowstyle()%>">
					<td><%=luci.util.pcdata(pkg.Package)%></td>
					<td><%=luci.util.pcdata(pkg.Version)%></td>
					<td><% if not pkg.Status or not pkg.Status.installed then %><input type="checkbox" name="install.<%=pkg.Package%>" value="1" /><% else %><%:installed%><% end %></td>
					<td><% if pkg.Status and pkg.Status.installed then %><input type="checkbox" name="remove.<%=pkg.Package%>" value="1" /><% else %><%:not installed%><% end %></td>
					<td><%=luci.util.pcdata(pkg.Description)%></td>
				</tr>
				<% end %>
			</table>

			<br />

			<div style="text-align: right">
				<input type="submit" class="cbi-input-apply" name="submit" value="<%:Perform Actions%>" />
			</div>
		</fieldset></fieldset>
	</div>
</form>
<%+footer%>
