<%#
LuCI - Lua Configuration Interface
Copyright 2008 Steven Barth <steven@midlink.org>
Copyright 2008 Jo-Philipp Wich <xm@leipzig.freifunk.net>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id$

-%>

<div class="cbi-map" id="cbi-<%=self.config%>">
	<% if self.title and #self.title > 0 then %><h2><a id="content" name="content"><%=self.title%></a></h2><% end %>
	<% if self.description and #self.description > 0 then %><div class="cbi-map-descr"><%=self.description%></div><% end %>
	<%- if self._apply then -%>
		<fieldset class="cbi-section" id="cbi-apply-<%=self.config%>">
			<legend><%:Applying changes%></legend>
			<script type="text/javascript"><![CDATA[
				var apply_xhr = new XHR();

				apply_xhr.get('<%=luci.dispatcher.build_url("servicectl", "restart", table.concat(self.parsechain, ","))%>', null,
					function() {
						var intv = window.setInterval(
							function() {
								apply_xhr.abort();
								apply_xhr.get('<%=luci.dispatcher.build_url("servicectl", "status")%>', null,
									function(x) {
										if( x.responseText == 'finish' )
										{
											window.clearInterval(intv);

											var e = document.getElementById('cbi-apply-<%=self.config%>-status');
											if( e )
											{
												e.innerHTML = '<%:Configuration applied.%>';
												window.setTimeout(function() { e.parentNode.style.display = 'none' }, 1000);
											}
										}
										else
										{
											var e = document.getElementById('cbi-apply-<%=self.config%>-status');
											if( e && x.responseText ) e.innerHTML = x.responseText;

										}
									}
								);
							}, 1000
						)
					}
				);
			]]></script>

			<img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>" style="vertical-align:middle" />
			<span id="cbi-apply-<%=self.config%>-status"><%:Waiting for router...%></span>
		</fieldset>
	<%- end -%>
	<%- self:render_children() %>
	<br />
</div>
